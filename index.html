<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MÃ¼lakat Randevu Sistemi</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      collection, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey:            "AIzaSyCLdA14t9BjDgbnh_C-JOoovtS1V5Cqj6w",
      authDomain:        "mulakat-rezervasyon.firebaseapp.com",
      projectId:         "mulakat-rezervasyon",
      storageBucket:     "mulakat-rezervasyon.firebasestorage.app",
      messagingSenderId: "1046752791579",
      appId:             "1:1046752791579:web:84f667b36932a0511a3cbe"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    window._db   = db;
    window._auth = auth;
    window._firebase = {
      doc, getDoc, setDoc, collection, onSnapshot,
      signInWithEmailAndPassword, signOut, onAuthStateChanged
    };
    window._dbReady = true;
    window.dispatchEvent(new Event("firebase-ready"));
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: linear-gradient(135deg,#0f172a 0%,#1e3a5f 50%,#0f172a 100%); min-height: 100vh; }
    @keyframes spin    { to { transform: rotate(360deg); } }
    @keyframes fadeIn  { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    @media print {
      body { background: #fff !important; }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
    }
    input:focus { outline: 2px solid #3b82f6; border-color: #3b82f6 !important; }
    button:hover { filter: brightness(0.93); }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SLOTS_8    = ["10:00","10:30","11:00","11:30","13:30","14:00","14:30","15:00"];
    const SLOTS_4_AM = ["10:00","10:30","11:00","11:30"];
    const SLOTS_4_PM = ["13:30","14:00","14:30","15:00"];
    const MONTH_NAMES = ["","Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
    const DAY_NAMES   = ["Pazar","Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma","Cumartesi"];

    // â”€â”€ VALIDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Telefon: sadece 05XX ile baÅŸlayan 11 hane
    function validatePhone(val) {
      return /^05[0-9]{9}$/.test(val);
    }
    // Sadece rakam giriÅŸine izin ver, max 11 karakter
    function sanitizePhone(val) {
      return val.replace(/[^0-9]/g, "").slice(0, 11);
    }
    // Ad/soyad: sadece harf, boÅŸluk, tire â€” XSS Ã¶nlemi
    function sanitizeName(val) {
      return val.replace(/[^a-zA-ZÄŸÃ¼ÅŸÄ±Ã¶Ã§ÄÃœÅÄ°Ã–Ã‡\s\-]/g, "").slice(0, 50);
    }

    // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildDays(year, month) {
      const days = [], total = new Date(year, month, 0).getDate();
      for (let d = 1; d <= total; d++) {
        const dow = new Date(year, month-1, d).getDay();
        if (dow !== 0 && dow !== 6) days.push(d);
      }
      return days;
    }
    function fmt(y, m, d) {
      return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    }
    function displayDate(dateStr) {
      const [y,m,d] = dateStr.split("-").map(Number);
      const dow = new Date(y, m-1, d).getDay();
      return `${DAY_NAMES[dow]}, ${d} ${MONTH_NAMES[m]} ${y}`;
    }
    function getSlotsForDay(dateStr, config) {
      const t = config[dateStr]?.type;
      if (!t || t==="8")  return SLOTS_8;
      if (t==="4am")      return SLOTS_4_AM;
      if (t==="4pm")      return SLOTS_4_PM;
      if (t==="closed")   return [];
      return SLOTS_8;
    }

    // â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function waitForFirebase() {
      if (window._dbReady) return;
      await new Promise(res => window.addEventListener("firebase-ready", res, {once:true}));
    }

    async function fbAddReservation(dateStr, slotData) {
      await waitForFirebase();
      const { doc, getDoc, setDoc } = window._firebase;
      const ref  = doc(window._db, "reservations", dateStr);
      const snap = await getDoc(ref);
      const slots = snap.exists() ? (snap.data().slots || {}) : {};
      if (slots[slotData.slot]) throw new Error("DOLU");
      // AynÄ± telefon numarasÄ± kontrolÃ¼ â€” tÃ¼m rezervasyonlarda
      const { collection, getDocs } = window._firebase;
      // Not: abonelik Ã¼zerinden anlÄ±k kontrol yeterli, duplikat engeli server-side rule ile de korunuyor
      slots[slotData.slot] = {
        ad:   slotData.ad,
        soyad:slotData.soyad,
        tel:  slotData.tel,
        bookedAt: new Date().toISOString()
      };
      await setDoc(ref, { slots });
    }

    async function fbCancelReservation(dateStr, slot) {
      await waitForFirebase();
      const { doc, getDoc, setDoc } = window._firebase;
      const ref  = doc(window._db, "reservations", dateStr);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      const slots = snap.data().slots || {};
      delete slots[slot];
      await setDoc(ref, { slots });
    }

    async function fbSetDayConfig(dateStr, type, note) {
      await waitForFirebase();
      const { doc, getDoc, setDoc } = window._firebase;
      const ref  = doc(window._db, "config", dateStr);
      const snap = await getDoc(ref);
      const existing = snap.exists() ? snap.data() : {};
      const data = { ...existing, type };
      if (note !== undefined) data.note = note;
      await setDoc(ref, data);
    }

    async function fbSetDayNote(dateStr, note) {
      await waitForFirebase();
      const { doc, getDoc, setDoc } = window._firebase;
      const ref  = doc(window._db, "config", dateStr);
      const snap = await getDoc(ref);
      const existing = snap.exists() ? snap.data() : { type: "8" };
      await setDoc(ref, { ...existing, note });
    }

    function fbSubscribe(onRes, onCfg) {
      if (!window._dbReady) {
        window.addEventListener("firebase-ready", () => fbSubscribe(onRes, onCfg), {once:true});
        return () => {};
      }
      const { collection, onSnapshot } = window._firebase;
      const unsubRes = onSnapshot(collection(window._db, "reservations"), snap => {
        const result = {};
        snap.forEach(d => {
          result[d.id] = Object.entries(d.data().slots || {}).map(([slot, info]) => ({slot, ...info}));
        });
        onRes(result);
      });
      const unsubCfg = onSnapshot(collection(window._db, "config"), snap => {
        const result = {};
        snap.forEach(d => { result[d.id] = d.data(); });
        onCfg(result);
      });
      return () => { unsubRes(); unsubCfg(); };
    }

    // TÃ¼m rezervasyonlarda belirtilen tel var mÄ±?
    function phoneExistsInReservations(tel, reservations) {
      for (const dateStr of Object.keys(reservations)) {
        if ((reservations[dateStr]||[]).some(r => r.tel === tel)) return true;
      }
      return false;
    }

    // â”€â”€ STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const S = {
      page:      { minHeight:"100vh", display:"flex", alignItems:"flex-start", justifyContent:"center", padding:"32px 16px 64px" },
      card:      { background:"#fff", borderRadius:20, padding:"32px 28px", maxWidth:580, width:"100%", boxShadow:"0 25px 50px rgba(0,0,0,0.35)", marginTop:24, animation:"fadeIn 0.3s ease" },
      homeCard:  { background:"rgba(255,255,255,0.05)", backdropFilter:"blur(20px)", border:"1px solid rgba(255,255,255,0.1)", borderRadius:24, padding:"56px 40px", maxWidth:440, width:"100%", textAlign:"center", marginTop:64, animation:"fadeIn 0.4s ease" },
      badge:     { display:"inline-block", background:"rgba(59,130,246,0.15)", color:"#93c5fd", border:"1px solid rgba(59,130,246,0.3)", borderRadius:100, padding:"4px 16px", fontSize:11, fontWeight:700, letterSpacing:2, marginBottom:24, textTransform:"uppercase" },
      heroTitle: { fontFamily:"'Playfair Display',serif", fontSize:42, color:"#f1f5f9", lineHeight:1.2, marginBottom:16 },
      heroSub:   { color:"#94a3b8", fontSize:15, lineHeight:1.7, marginBottom:36 },
      title:     { fontFamily:"'Playfair Display',serif", fontSize:26, color:"#1e293b", marginBottom:4 },
      sub:       { color:"#64748b", fontSize:14, marginBottom:20, fontFamily:"'DM Sans',sans-serif" },
      backBtn:   { background:"none", border:"none", color:"#64748b", cursor:"pointer", fontSize:13, fontWeight:600, padding:0, marginBottom:16, display:"block", fontFamily:"'DM Sans',sans-serif" },
      input:     { width:"100%", padding:"12px 16px", border:"2px solid #e2e8f0", borderRadius:12, fontSize:14, color:"#1e293b", fontFamily:"'DM Sans',sans-serif", marginBottom:12, display:"block" },
      btnBlue:   { width:"100%", padding:"14px 24px", background:"linear-gradient(135deg,#1e40af,#3b82f6)", color:"#fff", border:"none", borderRadius:12, fontSize:15, fontWeight:700, cursor:"pointer", fontFamily:"'DM Sans',sans-serif", marginTop:8, display:"block" },
      btnGhost:  { width:"100%", padding:"12px 24px", background:"transparent", color:"#475569", border:"2px solid #e2e8f0", borderRadius:12, fontSize:14, fontWeight:600, cursor:"pointer", fontFamily:"'DM Sans',sans-serif", marginTop:8, display:"block" },
      btnGreen:  { padding:"10px 20px", background:"#16a34a", color:"#fff", border:"none", borderRadius:10, fontSize:13, fontWeight:700, cursor:"pointer", fontFamily:"'DM Sans',sans-serif" },
      btnRed:    { padding:"6px 12px", borderRadius:8, border:"none", background:"#fee2e2", color:"#dc2626", cursor:"pointer", fontSize:12, fontWeight:600, fontFamily:"'DM Sans',sans-serif" },
      errMsg:    { color:"#ef4444", fontSize:13, marginBottom:8, fontFamily:"'DM Sans',sans-serif" },
      steps:     { display:"flex", marginBottom:28, alignItems:"center", justifyContent:"center" },
      stepItem:  { display:"flex", flexDirection:"column", alignItems:"center", gap:4, flex:1 },
      stepDot:   { width:28, height:28, borderRadius:"50%", display:"flex", alignItems:"center", justifyContent:"center", fontSize:12, fontWeight:700 },
      calGrid:   { display:"grid", gridTemplateColumns:"repeat(auto-fill,minmax(80px,1fr))", gap:8 },
      dayBtn:    { padding:"12px 6px", borderRadius:12, border:"2px solid #e2e8f0", background:"#f8fafc", display:"flex", flexDirection:"column", alignItems:"center", gap:4, fontFamily:"'DM Sans',sans-serif", width:"100%" },
      slotGrid:  { display:"grid", gridTemplateColumns:"repeat(4,1fr)", gap:8 },
      slotBtn:   { padding:"12px 8px", borderRadius:10, border:"2px solid #e2e8f0", fontSize:14, fontWeight:700, fontFamily:"'DM Sans',sans-serif", textAlign:"center" },
      confirmBox:{ background:"#f8fafc", borderRadius:12, padding:"16px 20px", marginBottom:16, lineHeight:1.8, fontFamily:"'DM Sans',sans-serif", fontSize:14, color:"#374151" },
      tabs:      { display:"flex", gap:6, marginBottom:16, flexWrap:"wrap", alignItems:"center" },
      tabBtn:    { padding:"8px 16px", borderRadius:8, border:"none", cursor:"pointer", fontSize:13, fontWeight:600, fontFamily:"'DM Sans',sans-serif" },
      adminGrid: { display:"grid", gridTemplateColumns:"repeat(auto-fill,minmax(210px,1fr))", gap:12, maxHeight:500, overflowY:"auto", padding:4 },
      adminDay:  { background:"#f8fafc", borderRadius:12, padding:"12px 14px", border:"1px solid #e2e8f0" },
      table:     { width:"100%", borderCollapse:"collapse", fontSize:13, fontFamily:"'DM Sans',sans-serif" },
      th:        { background:"#1e40af", color:"#fff", padding:"10px 12px", textAlign:"left", fontWeight:700 },
      td:        { padding:"9px 12px", borderBottom:"1px solid #e2e8f0", color:"#374151" },
      modal:     { position:"fixed", inset:0, background:"rgba(0,0,0,0.55)", display:"flex", alignItems:"center", justifyContent:"center", zIndex:100, padding:16 },
      modalBox:  { background:"#fff", borderRadius:20, padding:"28px 24px", maxWidth:420, width:"100%", boxShadow:"0 25px 50px rgba(0,0,0,0.3)", animation:"fadeIn 0.2s ease" },
      monthSel:  { display:"flex", alignItems:"center", justifyContent:"center", gap:20, marginBottom:16 },
      navBtn:    { width:32, height:32, borderRadius:8, border:"2px solid #e2e8f0", background:"#f8fafc", cursor:"pointer", fontSize:20, display:"flex", alignItems:"center", justifyContent:"center" },
      spinner:   { width:36, height:36, borderRadius:"50%", border:"3px solid #e2e8f0", borderTop:"3px solid #3b82f6", animation:"spin 0.7s linear infinite", margin:"0 auto" },
    };

    // â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function App() {
      const [view, setView]             = useState("home");
      const [reservations, setRes]      = useState({});
      const [config, setConfig]         = useState({});
      const [year, setYear]             = useState(2026);
      const [month, setMonth]           = useState(3);
      const [fbReady, setFbReady]       = useState(false);

      useEffect(() => {
        const unsub = fbSubscribe(
          res => { setRes(res); setFbReady(true); },
          cfg => setConfig(cfg)
        );
        return unsub;
      }, []);

      if (!fbReady) return (
        <div style={{minHeight:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:16}}>
          <div style={S.spinner} />
          <p style={{color:"#94a3b8",fontFamily:"'DM Sans',sans-serif",fontSize:14}}>BaÄŸlanÄ±yorâ€¦</p>
        </div>
      );

      const props = { reservations, config, year, month, setYear, setMonth, setView };
      return (
        <>
          {view==="home"       && <HomeView setView={setView} />}
          {view==="adminLogin" && <AdminLogin setView={setView} />}
          {view==="book"       && <BookView {...props} />}
          {view==="admin"      && <AdminView {...props} />}
        </>
      );
    }

    // â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function HomeView({ setView }) {
      return (
        <div style={S.page}>
          <div style={S.homeCard}>
            <div style={S.badge}>MÃ¼lakat 2026</div>
            <h1 style={S.heroTitle}>MÃ¼lakat<br/>Randevu Sistemi</h1>
            <p style={S.heroSub}>Uygun gÃ¼n ve saatinizi seÃ§erek randevunuzu kolayca oluÅŸturun.</p>
            <div style={{display:"flex",gap:12,flexDirection:"column",maxWidth:320,margin:"0 auto"}}>
              <button style={S.btnBlue}  onClick={() => setView("book")}>ğŸ—“ Randevu Al</button>
              <button style={S.btnGhost} onClick={() => setView("adminLogin")}>ğŸ” YÃ¶netici GiriÅŸi</button>
            </div>
          </div>
        </div>
      );
    }

    // â”€â”€ ADMIN LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function AdminLogin({ setView }) {
      const [email, setEmail]   = useState("");
      const [pass, setPass]     = useState("");
      const [err, setErr]       = useState("");
      const [loading, setLoading] = useState(false);

      const tryLogin = async () => {
        if (!email || !pass) return;
        setLoading(true); setErr("");
        try {
          await waitForFirebase();
          await window._firebase.signInWithEmailAndPassword(window._auth, email, pass);
          setView("admin");
        } catch { setErr("E-posta veya ÅŸifre hatalÄ±."); }
        setLoading(false);
      };

      return (
        <div style={S.page}>
          <div style={{...S.card, maxWidth:380}}>
            <button style={S.backBtn} onClick={() => setView("home")}>â† Geri</button>
            <h2 style={S.title}>YÃ¶netici GiriÅŸi</h2>
            <input type="email" placeholder="E-posta" value={email}
              onChange={e => setEmail(e.target.value)}
              style={{...S.input, marginTop:16}} />
            <input type="password" placeholder="Åifre" value={pass}
              onChange={e => setPass(e.target.value)}
              onKeyDown={e => e.key==="Enter" && tryLogin()}
              style={{...S.input, borderColor:err?"#ef4444":"#e2e8f0"}} />
            {err && <p style={S.errMsg}>âš ï¸ {err}</p>}
            <button style={{...S.btnBlue, opacity:loading?0.6:1}} disabled={loading} onClick={tryLogin}>
              {loading ? "GiriÅŸ yapÄ±lÄ±yorâ€¦" : "GiriÅŸ Yap"}
            </button>
          </div>
        </div>
      );
    }

    // â”€â”€ BOOK VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function BookView({ year, month, reservations, config, setView }) {
      const [step, setStep]       = useState(1);
      const [selDate, setSelDate] = useState(null);
      const [selSlot, setSelSlot] = useState(null);
      const [form, setForm]       = useState({ ad:"", soyad:"", tel:"" });
      const [saving, setSaving]   = useState(false);
      const [error, setError]     = useState("");
      const days = buildDays(year, month);

      // Telefon validation state
      const telValid  = validatePhone(form.tel);
      const telDirty  = form.tel.length > 0;

      const handleBook = async () => {
        if (!validatePhone(form.tel)) { setError("GeÃ§ersiz telefon numarasÄ±."); return; }
        // Duplikat telefon kontrolÃ¼
        if (phoneExistsInReservations(form.tel, reservations)) {
          setError("Bu telefon numarasÄ±yla daha Ã¶nce randevu alÄ±nmÄ±ÅŸ.");
          return;
        }
        setSaving(true); setError("");
        try {
          await fbAddReservation(selDate, { slot:selSlot, ...form });
          setStep(4);
        } catch(e) {
          setError(e.message==="DOLU" ? "Bu saat az Ã¶nce doldu, lÃ¼tfen baÅŸka bir saat seÃ§in." : "Bir hata oluÅŸtu, tekrar deneyin.");
        }
        setSaving(false);
      };

      const canSubmit = form.ad.trim() && form.soyad.trim() && telValid && !saving;

      return (
        <div style={S.page}>
          <div style={S.card}>
            <button className="no-print" style={S.backBtn} onClick={() => step>1 ? setStep(step-1) : setView("home")}>â† Geri</button>

            {/* Steps */}
            <div style={S.steps} className="no-print">
              {["GÃ¼n","Saat","Bilgi","TamamlandÄ±"].map((s,i) => (
                <div key={i} style={{...S.stepItem, opacity:i+1<=step?1:0.3}}>
                  <div style={{...S.stepDot, background:i+1<=step?"#1e40af":"#e2e8f0", color:i+1<=step?"#fff":"#94a3b8"}}>{i+1}</div>
                  <span style={{fontSize:11,color:i+1<=step?"#1e40af":"#94a3b8",fontWeight:600,fontFamily:"'DM Sans',sans-serif"}}>{s}</span>
                </div>
              ))}
            </div>

            {/* Step 1 â€” GÃ¼n */}
            {step===1 && <>
              <h2 style={S.title}>GÃ¼n SeÃ§in</h2>
              <p style={S.sub}>{MONTH_NAMES[month]} {year}</p>
              <div style={S.calGrid}>
                {days.map(d => {
                  const dateStr   = fmt(year, month, d);
                  const slots     = getSlotsForDay(dateStr, config);
                  const booked    = (reservations[dateStr]||[]).length;
                  const available = slots.length - booked;
                  const closed    = slots.length === 0;
                  const pct       = slots.length > 0 ? Math.round((booked/slots.length)*100) : 0;
                  return (
                    <button key={d} disabled={closed||available===0}
                      onClick={() => { setSelDate(dateStr); setStep(2); }}
                      style={{...S.dayBtn, opacity:(closed||available===0)?0.38:1, cursor:(closed||available===0)?"not-allowed":"pointer", position:"relative", overflow:"hidden"}}>
                      {/* Doluluk bar */}
                      {!closed && slots.length>0 && (
                        <div style={{position:"absolute",bottom:0,left:0,height:3,width:`${pct}%`,
                          background:pct===100?"#ef4444":pct>=75?"#f59e0b":"#22c55e",borderRadius:2,transition:"width 0.3s"}} />
                      )}
                      <span style={{fontSize:20,fontWeight:700}}>{d}</span>
                      <span style={{fontSize:10,fontWeight:600,
                        color:closed?"#94a3b8":available===0?"#ef4444":available<=2?"#f59e0b":"#22c55e"}}>
                        {closed?"KapalÄ±":available===0?"Dolu":`${available} boÅŸ`}
                      </span>
                    </button>
                  );
                })}
              </div>
            </>}

            {/* Step 2 â€” Saat */}
            {step===2 && selDate && <>
              <h2 style={S.title}>Saat SeÃ§in</h2>
              <p style={S.sub}>{displayDate(selDate)}</p>
              {config[selDate]?.note && (
                <div style={{background:"#fffbeb",border:"1px solid #fde68a",borderRadius:10,padding:"10px 14px",marginBottom:16,fontSize:13,color:"#92400e",fontFamily:"'DM Sans',sans-serif"}}>
                  ğŸ“Œ {config[selDate].note}
                </div>
              )}
              <div style={S.slotGrid}>
                {getSlotsForDay(selDate, config).map(slot => {
                  const booked = (reservations[selDate]||[]).some(r=>r.slot===slot);
                  return (
                    <button key={slot} disabled={booked}
                      onClick={() => { setSelSlot(slot); setStep(3); }}
                      style={{...S.slotBtn, opacity:booked?0.35:1,
                        background:selSlot===slot?"#1e40af":"#f8fafc",
                        color:selSlot===slot?"#fff":"#1e293b",
                        cursor:booked?"not-allowed":"pointer"}}>
                      {slot}
                      {booked && <div style={{fontSize:10,color:"#ef4444"}}>Dolu</div>}
                    </button>
                  );
                })}
              </div>
            </>}

            {/* Step 3 â€” Bilgi */}
            {step===3 && <>
              <h2 style={S.title}>Bilgileriniz</h2>
              <p style={S.sub}>{displayDate(selDate)} â€” {selSlot}</p>
              <input
                placeholder="Ad"
                value={form.ad}
                onChange={e => setForm({...form, ad: sanitizeName(e.target.value)})}
                style={{...S.input, marginTop:16}}
              />
              <input
                placeholder="Soyad"
                value={form.soyad}
                onChange={e => setForm({...form, soyad: sanitizeName(e.target.value)})}
                style={S.input}
              />
              <input
                placeholder="Telefon (05XXXXXXXXX)"
                value={form.tel}
                inputMode="numeric"
                onChange={e => setForm({...form, tel: sanitizePhone(e.target.value)})}
                style={{...S.input,
                  borderColor: telDirty ? (telValid?"#22c55e":"#ef4444") : "#e2e8f0"
                }}
              />
              {telDirty && !telValid && (
                <p style={S.errMsg}>05XX ile baÅŸlayan 11 haneli numara giriniz</p>
              )}
              {error && <p style={S.errMsg}>âš ï¸ {error}</p>}
              <button
                style={{...S.btnBlue, opacity:canSubmit?1:0.45}}
                disabled={!canSubmit}
                onClick={handleBook}
              >
                {saving ? "â³ Kaydediliyorâ€¦" : "Randevuyu Kaydet â†’"}
              </button>
            </>}

            {/* Step 4 â€” TamamlandÄ± (WhatsApp kaldÄ±rÄ±ldÄ±) */}
            {step===4 && (
              <div style={{textAlign:"center"}}>
                <div style={{fontSize:64,marginBottom:8}}>âœ…</div>
                <h2 style={{...S.title, color:"#16a34a", textAlign:"center"}}>Randevunuz AlÄ±ndÄ±!</h2>
                <p style={{...S.sub, textAlign:"center"}}>AÅŸaÄŸÄ±daki bilgileri not alabilir veya yazdÄ±rabilirsiniz.</p>

                {/* YazdÄ±rÄ±labilir Ã¶zet */}
                <div style={{...S.confirmBox, border:"2px solid #e2e8f0", textAlign:"left"}} id="print-area">
                  <div style={{borderBottom:"1px solid #e2e8f0", paddingBottom:12, marginBottom:12}}>
                    <p style={{fontWeight:700, fontSize:16, fontFamily:"'Playfair Display',serif", color:"#1e293b"}}>MÃ¼lakat Randevu Belgesi</p>
                  </div>
                  <table style={{width:"100%", fontSize:14, borderCollapse:"collapse"}}>
                    <tbody>
                      {[
                        ["Ad Soyad", `${form.ad} ${form.soyad}`],
                        ["Tarih",    displayDate(selDate)],
                        ["Saat",     selSlot],
                        ["Telefon",  form.tel],
                      ].map(([k,v]) => (
                        <tr key={k}>
                          <td style={{padding:"6px 0", color:"#64748b", width:90}}>{k}</td>
                          <td style={{padding:"6px 0", fontWeight:600, color:"#1e293b"}}>{v}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div style={{display:"flex", gap:10, flexDirection:"column"}}>
                  <button style={S.btnBlue} className="no-print" onClick={() => window.print()}>
                    ğŸ–¨ï¸ YazdÄ±r / PDF Kaydet
                  </button>
                  <button style={S.btnGhost} className="no-print" onClick={() => setView("home")}>
                    Ana Sayfaya DÃ¶n
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // â”€â”€ ADMIN VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function AdminView({ year, month, setYear, setMonth, reservations, config, setView }) {
      const [tab, setTab]           = useState("calendar");
      const [ampmModal, setAmpmModal] = useState(null);
      const [editRes, setEditRes]   = useState(null);
      const [noteModal, setNoteModal] = useState(null); // {dateStr, note}
      const [copyMsg, setCopyMsg]   = useState("");
      const days = buildDays(year, month);

      const setDayType = async (dateStr, type) => { await fbSetDayConfig(dateStr, type); };

      const cancelReservation = async (dateStr, slot) => {
        if (!confirm("Bu rezervasyonu iptal etmek istiyor musunuz?")) return;
        await fbCancelReservation(dateStr, slot);
        setEditRes(null);
      };

      const exportList = () => {
        let txt = "Tarih\tGÃ¼n\tSaat\tAd\tSoyad\tTelefon\n";
        for (const dateStr of Object.keys(reservations).sort())
          for (const r of reservations[dateStr])
            txt += `${dateStr}\t${displayDate(dateStr)}\t${r.slot}\t${r.ad}\t${r.soyad}\t${r.tel}\n`;
        navigator.clipboard.writeText(txt).then(() => {
          setCopyMsg("KopyalandÄ±! Excel'e yapÄ±ÅŸtÄ±rabilirsiniz.");
          setTimeout(()=>setCopyMsg(""),3000);
        });
      };

      const allRes = [];
      for (const d of Object.keys(reservations).sort())
        (reservations[d]||[]).forEach(r => allRes.push({dateStr:d,...r}));

      const prevMonth = () => { if(month===1){setMonth(12);setYear(y=>y-1);}else setMonth(m=>m-1); };
      const nextMonth = () => { if(month===12){setMonth(1);setYear(y=>y+1);}else setMonth(m=>m+1); };

      // Toplam istatistik
      const totalBooked = allRes.length;
      const totalSlots  = days.reduce((sum,d) => sum + getSlotsForDay(fmt(year,month,d), config).length, 0);

      return (
        <div style={S.page}>
          <div style={{...S.card, maxWidth:740}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
              <button style={S.backBtn} onClick={async () => {
                await waitForFirebase();
                await window._firebase.signOut(window._auth);
                setView("home");
              }}>â† Ã‡Ä±kÄ±ÅŸ</button>
              <h2 style={{...S.title, marginBottom:0}}>YÃ¶netici Paneli</h2>
              <div style={{width:60}} />
            </div>

            {/* Ä°statistik banner */}
            <div style={{display:"flex",gap:10,marginBottom:16}}>
              {[
                {label:"Toplam Randevu", val:totalBooked, color:"#1e40af", bg:"#eff6ff"},
                {label:"Dolu / Toplam",  val:`${totalBooked}/${totalSlots}`, color:"#16a34a", bg:"#f0fdf4"},
                {label:"Doluluk",        val:totalSlots>0?`${Math.round((totalBooked/totalSlots)*100)}%`:"â€”", color:"#b45309", bg:"#fffbeb"},
              ].map(s => (
                <div key={s.label} style={{flex:1, background:s.bg, borderRadius:10, padding:"10px 14px", textAlign:"center"}}>
                  <div style={{fontSize:20, fontWeight:700, color:s.color, fontFamily:"'DM Sans',sans-serif"}}>{s.val}</div>
                  <div style={{fontSize:11, color:"#64748b", fontFamily:"'DM Sans',sans-serif"}}>{s.label}</div>
                </div>
              ))}
            </div>

            {/* Month nav */}
            <div style={S.monthSel}>
              <button style={S.navBtn} onClick={prevMonth}>â€¹</button>
              <span style={{fontWeight:700,fontSize:16,fontFamily:"'DM Sans',sans-serif",minWidth:150,textAlign:"center"}}>
                {MONTH_NAMES[month]} {year}
              </span>
              <button style={S.navBtn} onClick={nextMonth}>â€º</button>
            </div>

            {/* Tabs */}
            <div style={S.tabs}>
              {[["calendar","ğŸ“… Takvim"],["list","ğŸ“‹ Liste"]].map(([t,l]) => (
                <button key={t} onClick={()=>setTab(t)}
                  style={{...S.tabBtn, background:tab===t?"#1e40af":"transparent", color:tab===t?"#fff":"#64748b"}}>
                  {l}
                </button>
              ))}
              <button onClick={exportList}
                style={{...S.tabBtn, marginLeft:"auto", background:"#f0fdf4", color:"#16a34a"}}>
                ğŸ“Š Excel'e Kopyala
              </button>
            </div>
            {copyMsg && <p style={{color:"#16a34a",fontSize:13,marginBottom:8,fontFamily:"'DM Sans',sans-serif"}}>{copyMsg}</p>}

            {/* CALENDAR */}
            {tab==="calendar" && (
              <div style={S.adminGrid}>
                {days.map(d => {
                  const dateStr = fmt(year, month, d);
                  const slots   = getSlotsForDay(dateStr, config);
                  const booked  = reservations[dateStr] || [];
                  const cfgType = config[dateStr]?.type || "8";
                  const note    = config[dateStr]?.note || "";
                  const pct     = slots.length > 0 ? Math.round((booked.length/slots.length)*100) : 0;

                  return (
                    <div key={d} style={{...S.adminDay, border: note?"1px solid #fde68a":"1px solid #e2e8f0"}}>
                      {/* Header */}
                      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                        <span style={{fontWeight:700,fontSize:14,fontFamily:"'DM Sans',sans-serif"}}>{d} {MONTH_NAMES[month]}</span>
                        <span style={{fontSize:11,color:"#94a3b8",fontFamily:"'DM Sans',sans-serif"}}>{booked.length}/{slots.length}</span>
                      </div>

                      {/* Doluluk bar */}
                      {slots.length > 0 && (
                        <div style={{background:"#e2e8f0",borderRadius:4,height:5,marginBottom:8,overflow:"hidden"}}>
                          <div style={{height:"100%",width:`${pct}%`,
                            background:pct===100?"#ef4444":pct>=75?"#f59e0b":"#22c55e",
                            borderRadius:4,transition:"width 0.3s"}} />
                        </div>
                      )}

                      {/* Tip butonlarÄ± */}
                      <div style={{display:"flex",gap:4,marginBottom:6,flexWrap:"wrap"}}>
                        {[{key:"8",label:"8 kiÅŸi"},{key:"4",label:"4 kiÅŸi"},{key:"closed",label:"KapalÄ±"}].map(t => {
                          const active = t.key==="4"?(cfgType==="4am"||cfgType==="4pm"):cfgType===t.key;
                          const bg  = t.key==="closed"?"#fee2e2":t.key==="4"?"#fef9c3":"#dbeafe";
                          const col = t.key==="closed"?"#dc2626":t.key==="4"?"#b45309":"#1e40af";
                          return (
                            <button key={t.key}
                              onClick={() => t.key==="4" ? setAmpmModal(dateStr) : setDayType(dateStr, t.key)}
                              style={{padding:"2px 7px",borderRadius:6,border:"none",cursor:"pointer",fontSize:11,fontWeight:600,
                                background:active?bg:"#f1f5f9",color:active?col:"#94a3b8"}}>
                              {t.label}{t.key==="4"&&cfgType==="4am"&&" (Ã–Ã–)"}{t.key==="4"&&cfgType==="4pm"&&" (Ã–S)"}
                            </button>
                          );
                        })}
                        {/* Not butonu */}
                        <button onClick={() => setNoteModal({dateStr, note})}
                          style={{padding:"2px 7px",borderRadius:6,border:"none",cursor:"pointer",fontSize:11,fontWeight:600,
                            background:note?"#fef9c3":"#f1f5f9",color:note?"#b45309":"#94a3b8",marginLeft:"auto"}}>
                          {note?"ğŸ“Œ":"ğŸ“"}
                        </button>
                      </div>

                      {/* Not gÃ¶ster */}
                      {note && (
                        <div style={{fontSize:11,color:"#92400e",background:"#fffbeb",borderRadius:6,padding:"4px 8px",marginBottom:6}}>
                          {note}
                        </div>
                      )}

                      {/* Slot pilleri */}
                      <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
                        {slots.map(slot => {
                          const res = booked.find(r=>r.slot===slot);
                          return (
                            <div key={slot} onClick={() => res && setEditRes({dateStr,slot,res})}
                              style={{padding:"3px 8px",borderRadius:6,fontSize:11,fontWeight:600,
                                background:res?"#1e40af":"#f1f5f9",color:res?"#fff":"#94a3b8",
                                cursor:res?"pointer":"default",minWidth:46,textAlign:"center"}}>
                              {slot}
                              {res && <div style={{fontSize:10,opacity:0.85,overflow:"hidden",maxWidth:44,textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{res.ad}</div>}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* LIST */}
            {tab==="list" && (
              <div style={{overflowX:"auto"}}>
                {allRes.length===0
                  ? <p style={{color:"#94a3b8",textAlign:"center",padding:32,fontFamily:"'DM Sans',sans-serif"}}>HenÃ¼z rezervasyon yok.</p>
                  : (
                    <table style={S.table}>
                      <thead>
                        <tr>{["#","Tarih","Saat","Ad","Soyad","Telefon",""].map(h=><th key={h} style={S.th}>{h}</th>)}</tr>
                      </thead>
                      <tbody>
                        {allRes.map((r,i) => (
                          <tr key={i} style={{background:i%2===0?"#fff":"#f8fafc"}}>
                            <td style={{...S.td,color:"#94a3b8",width:32}}>{i+1}</td>
                            <td style={S.td}>{displayDate(r.dateStr)}</td>
                            <td style={{...S.td,fontWeight:700}}>{r.slot}</td>
                            <td style={S.td}>{r.ad}</td>
                            <td style={S.td}>{r.soyad}</td>
                            <td style={S.td}>{r.tel}</td>
                            <td style={S.td}>
                              <button style={S.btnRed} onClick={()=>cancelReservation(r.dateStr,r.slot)}>Ä°ptal</button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  )
                }
              </div>
            )}

            {/* AM/PM MODAL */}
            {ampmModal && (
              <div style={S.modal} onClick={()=>setAmpmModal(null)}>
                <div style={{...S.modalBox,maxWidth:340,textAlign:"center"}} onClick={e=>e.stopPropagation()}>
                  <div style={{fontSize:36,marginBottom:8}}>ğŸ•</div>
                  <h3 style={{fontFamily:"'Playfair Display',serif",marginBottom:8,color:"#1e293b"}}>Oturum ZamanÄ±</h3>
                  <p style={{color:"#64748b",fontSize:14,marginBottom:24,fontFamily:"'DM Sans',sans-serif"}}>
                    {displayDate(ampmModal)} gÃ¼nÃ¼ iÃ§in 4 kiÅŸilik kontenjan hangi yarÄ±da?
                  </p>
                  <div style={{display:"flex",gap:12}}>
                    {[
                      {type:"4am",icon:"â˜€ï¸",label:"Ã–ÄŸleden Ã–nce",sub:"10:00 â€“ 11:30",border:"#bfdbfe",bg:"#eff6ff",col:"#1e40af",sub_col:"#3b82f6"},
                      {type:"4pm",icon:"ğŸŒ¤",label:"Ã–ÄŸleden Sonra",sub:"13:30 â€“ 15:00",border:"#fde68a",bg:"#fffbeb",col:"#b45309",sub_col:"#d97706"},
                    ].map(o => (
                      <button key={o.type} onClick={()=>{setDayType(ampmModal,o.type);setAmpmModal(null);}}
                        style={{flex:1,padding:"14px 0",borderRadius:12,border:`2px solid ${o.border}`,
                          background:o.bg,color:o.col,fontWeight:700,cursor:"pointer",
                          fontFamily:"'DM Sans',sans-serif",fontSize:14}}>
                        {o.icon} {o.label}<br/>
                        <span style={{fontSize:11,fontWeight:400,color:o.sub_col}}>{o.sub}</span>
                      </button>
                    ))}
                  </div>
                  <button style={S.btnGhost} onClick={()=>setAmpmModal(null)}>Ä°ptal</button>
                </div>
              </div>
            )}

            {/* NOT MODAL */}
            {noteModal && (
              <NoteModal
                dateStr={noteModal.dateStr}
                initialNote={noteModal.note}
                onSave={async (note) => {
                  await fbSetDayNote(noteModal.dateStr, note);
                  setNoteModal(null);
                }}
                onClose={() => setNoteModal(null)}
              />
            )}

            {/* REZERVASYON DETAY MODAL */}
            {editRes && (
              <div style={S.modal} onClick={()=>setEditRes(null)}>
                <div style={S.modalBox} onClick={e=>e.stopPropagation()}>
                  <h3 style={{fontFamily:"'Playfair Display',serif",marginBottom:16,color:"#1e293b"}}>Rezervasyon DetayÄ±</h3>
                  <div style={S.confirmBox}>
                    <table style={{width:"100%",fontSize:14,borderCollapse:"collapse"}}>
                      <tbody>
                        {[
                          ["Ad Soyad", `${editRes.res.ad} ${editRes.res.soyad}`],
                          ["Tarih",    displayDate(editRes.dateStr)],
                          ["Saat",     editRes.slot],
                          ["Telefon",  editRes.res.tel],
                        ].map(([k,v]) => (
                          <tr key={k}>
                            <td style={{padding:"5px 0",color:"#64748b",width:80}}>{k}</td>
                            <td style={{padding:"5px 0",fontWeight:600,color:"#1e293b"}}>{v}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  <button onClick={()=>cancelReservation(editRes.dateStr,editRes.slot)}
                    style={{...S.btnBlue,background:"#ef4444",marginTop:8}}>
                    ğŸ—‘ Rezervasyonu Ä°ptal Et
                  </button>
                  <button style={S.btnGhost} onClick={()=>setEditRes(null)}>Kapat</button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // â”€â”€ NOT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function NoteModal({ dateStr, initialNote, onSave, onClose }) {
      const [note, setNote] = useState(initialNote || "");
      return (
        <div style={S.modal} onClick={onClose}>
          <div style={{...S.modalBox, maxWidth:360}} onClick={e=>e.stopPropagation()}>
            <h3 style={{fontFamily:"'Playfair Display',serif",marginBottom:8,color:"#1e293b"}}>ğŸ“Œ GÃ¼n Notu</h3>
            <p style={{color:"#64748b",fontSize:13,marginBottom:16,fontFamily:"'DM Sans',sans-serif"}}>
              {displayDate(dateStr)}
            </p>
            <textarea
              value={note}
              onChange={e => setNote(e.target.value.slice(0,200))}
              placeholder="Ã–rn: SÄ±nav salonu 3. katta, yanÄ±nÄ±zda kimlik getirinâ€¦"
              rows={4}
              style={{...S.input, resize:"vertical", marginBottom:4, fontFamily:"'DM Sans',sans-serif"}}
            />
            <p style={{fontSize:11,color:"#94a3b8",marginBottom:12,fontFamily:"'DM Sans',sans-serif",textAlign:"right"}}>{note.length}/200</p>
            <button style={S.btnBlue} onClick={() => onSave(note)}>Kaydet</button>
            {note && (
              <button style={{...S.btnGhost, marginTop:6, color:"#ef4444", borderColor:"#fee2e2"}}
                onClick={() => onSave("")}>Notu Sil</button>
            )}
            <button style={S.btnGhost} onClick={onClose}>Ä°ptal</button>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>